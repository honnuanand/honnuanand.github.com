---
layout: post
title: Installing PCF 2.X  on Azure using Concourse - Part - 2 ,  Concourse using
  bosh
date: '2018-07-31T09:42:00.000-07:00'
author: Anand Rao
tags:
- Pivotal Cloud Foundry
- PCF
- Cloud Foundry
modified_time: '2018-08-09T23:17:45.397-07:00'
thumbnail: https://2.bp.blogspot.com/-aoohbb2SHWw/W2AKlxdfOaI/AAAAAAAAGIw/cITnFGIp8XMZfL1Cku5IABvmmTdgOFO8wCLcBGAs/s72-c/stemcell.png
blogger_id: tag:blogger.com,1999:blog-3696969976504014907.post-7162921848542931033
blogger_orig_url: https://blog.clue2solve.io/2018/07/installing-pcf-2x-on-azure-using_31.html
---

This Blog Entry is a part 2 of a series. The <a href="http://blog.clue2solve.io/2018/07/installing-pcf-2x-on-azure-using.html" target="_blank">Part - 1</a> covered the bbl and bosh installation.<br /><b><u><br /></u></b> When you go to the <a href="http://concourse-ci.org/">concourse-ci.org</a> website and start looking at multiple ways to install concourse,&nbsp; you start wondering whats the best practice to install concourse. Speaking to a many of the amazing folks at Pivotal I decided to follow the path of installing Bosh and having Bosh start and manage concourse. When it comes to installing Bosh, once again there are multiple ways to do this. The Bosh-Boot-loader project comes in very handy to get your bosh instance up and running in the quickest time.<br /><br />With the successful install of bbl and bosh as part of the<a href="http://blog.clue2solve.io/2018/07/installing-pcf-2x-on-azure-using.html" target="_blank"> Part-1</a> of this series , lets dive into the installation of concourse using the bosh instance that we have running.<br /><br />The first step in this process is downloading ( cloning from github) a copy of the <a href="https://github.com/concourse/concourse-bosh-deployment" target="_blank">concourse-bosh-deployment.</a><br /><pre><code><i style="background-color: #f3f3f3;"><br /></i><pre><code><i><span style="background-color: #f3f3f3;">anandrao at Anands-MBP in ~/pivotal/repos/bbl-az/bbl<br />$ cd ..<br /><br />anandrao at Anands-MBP in ~/pivotal/repos/bbl-az<br />$ mkdir concourse ; cd  concourse<br /><br />anandrao at Anands-MBP in ~/pivotal/repos/bbl-az/concourse<br />$ git clone https://github.com/concourse/concourse-bosh-deployment.git<br />Cloning into 'concourse-bosh-deployment'...<br />remote: Counting objects: 705, done.<br />remote: Compressing objects: 100% (79/79), done.<br />remote: Total 705 (delta 58), reused 58 (delta 26), pack-reused 600<br />Receiving objects: 100% (705/705), 121.01 KiB | 1.66 MiB/s, done.<br />Resolving deltas: 100% (384/384), done.</span></i></code></pre><i style="background-color: #f3f3f3;"></i></code></pre>Next , we will need to find out the version of OS/Stemcell that is referenced in the <b>concourse.yml</b> file. On the Latest version as of today, here is what I found:<br /><pre><code><i style="background-color: #f3f3f3;"><br /></i></code></pre><pre><code><pre><i style="background-color: #f3f3f3;"><code>stemcells:<br />- alias: xenial<br />  os: ubuntu-xenial<br />  version: latest</code></i></pre></code></pre><pre><code><i style="background-color: #f3f3f3;"><br /></i></code></pre>Ok , <b>ubuntu-xenial</b> it is. Remember , it used to trusty before. Armed with this info, lets hunt down the <b>stemcell</b> for this. Best place to find this will be&nbsp;<a href="https://bosh.io/stemcells" target="_blank">https://bosh.io/stemcells</a>.<br /><div><br /></div><div><i style="background-color: #f3f3f3;"><a href="https://2.bp.blogspot.com/-aoohbb2SHWw/W2AKlxdfOaI/AAAAAAAAGIw/cITnFGIp8XMZfL1Cku5IABvmmTdgOFO8wCLcBGAs/s1600/stemcell.png" imageanchor="1" style="clear: left; margin-bottom: 1em; margin-right: 1em;"><img border="0" data-original-height="983" data-original-width="1600" height="246" src="https://2.bp.blogspot.com/-aoohbb2SHWw/W2AKlxdfOaI/AAAAAAAAGIw/cITnFGIp8XMZfL1Cku5IABvmmTdgOFO8wCLcBGAs/s400/stemcell.png" width="400" /></a></i></div><div><i><br /></i></div><div>Using the command on that page ,&nbsp; lets upload the stemcell to bosh.&nbsp;&nbsp;</div><div><br /></div><div><pre><code><span style="background-color: #f3f3f3;"><i>anandrao at Anands-MBP in ~/pivotal/repos/bbl-az/concourse/concourse-bosh-deployment/cluster (master)<br />$ bosh upload-stemcell --sha1 1d660dcbb51a1c80914fbb8c11173e640014f6c5 \<br />  https://bosh.io/d/stemcells/bosh-azure-hyperv-ubuntu-xenial-go_agent\?v\=97.3<br />Using environment 'https://10.0.0.6:25555' as client 'admin'<br /><br />Task 9<br /><br />Task 9 | 07:09:48 | Update stemcell: Downloading remote stemcell (00:00:15)<br />Task 9 | 07:10:03 | Update stemcell: Verifying remote stemcell (00:00:02)<br />Task 9 | 07:10:05 | Update stemcell: Extracting stemcell archive (00:00:04)<br />Task 9 | 07:10:10 | Update stemcell: Verifying stemcell manifest (00:00:00)<br />Task 9 | 07:11:20 | Update stemcell: Checking if this stemcell already exists (00:00:00)<br />Task 9 | 07:11:20 | Update stemcell: Uploading stemcell bosh-azure-hyperv-ubuntu-xenial-go_agent/97.3 to the cloud (00:02:54)<br />Task 9 | 07:14:14 | Update stemcell: Save stemcell bosh-azure-hyperv-ubuntu-xenial-go_agent/97.3 (bosh-stemcell-05475b0d-eca0-4666-839b-07b2db8a80c4) (00:00:00)<br /><br />Task 9 Started  Tue Jul 31 07:09:48 UTC 2018<br />Task 9 Finished Tue Jul 31 07:14:14 UTC 2018<br />Task 9 Duration 00:04:26<br />Task 9 done<br /><br />Succeeded</i></span></code></pre></div><div><br /></div><div>Ok,&nbsp; the Stemcell is in, lets run the bosh magic to get concourse running. One step we need to do as a bbl step here is to add a load-balancer for concourse. Remember,&nbsp; we did not add this in our initial infra creation.&nbsp; Its easy to update out bbl plan and re-apply.&nbsp;</div><div><br /></div><div>Switch back to the bbl folder and exec "<i>bbl plan --lb-type concourse" </i>as below and then run<i> "bbl up".</i></div><div><br /><pre><code><br /><span style="background-color: #f3f3f3;"><i>anandrao at Anands-MBP in ~/pivotal/repos/bbl-az/bbl<br />$ pwd<br />/Users/anandrao/pivotal/repos/bbl-az/bbl<br /><br />anandrao at Anands-MBP in ~/pivotal/repos/bbl-az/bbl<br />$ ls<br />bbl-all-exports.PS1 bosh-deployment     create-director.sh  delete-director.sh  jumpbox-deployment  vars<br />bbl-state.json      cloud-config        create-jumpbox.sh   delete-jumpbox.sh   terraform<br /><br />anandrao at Anands-MBP in ~/pivotal/repos/bbl-az/bbl<br />$ <b>bbl plan --lb-type concourse</b><br />step: generating terraform template<br />step: generating terraform variables<br />step: terraform init<br /><br />anandrao at Anands-MBP in ~/pivotal/repos/bbl-az/bbl<br />$ bbl up<br />step: terraform init<br />step: terraform apply<br />step: creating jumpbox<br />Deployment manifest: '/Users/anandrao/pivotal/repos/bbl-az/bbl/jumpbox-deployment/jumpbox.yml'<br />Deployment state: '/Users/anandrao/pivotal/repos/bbl-az/bbl/vars/jumpbox-state.json'<br /><br />Started validating<br />  Downloading release 'os-conf'... Skipped [Found in local cache] (00:00:00)<br />  Validating release 'os-conf'... Finished (00:00:00)<br />  Downloading release 'bosh-azure-cpi'... Skipped [Found in local cache] (00:00:00)<br />  Validating release 'bosh-azure-cpi'... Finished (00:00:00)<br />  Validating cpi release... Finished (00:00:00)<br />  Validating deployment manifest... Finished (00:00:00)<br />  Downloading stemcell... Skipped [Found in local cache] (00:00:00)<br />  Validating stemcell... Finished (00:00:01)<br />Finished validating (00:00:01)<br />No deployment, stemcell or release changes. Skipping deploy.<br /><br />Succeeded<br />step: created jumpbox<br />step: creating bosh director<br />Deployment manifest: '/Users/anandrao/pivotal/repos/bbl-az/bbl/bosh-deployment/bosh.yml'<br />Deployment state: '/Users/anandrao/pivotal/repos/bbl-az/bbl/vars/bosh-state.json'<br /><br />Started validating<br />  Downloading release 'bosh'... Skipped [Found in local cache] (00:00:00)<br />  Validating release 'bosh'... Finished (00:00:00)<br />  Downloading release 'bpm'... Skipped [Found in local cache] (00:00:00)<br />  Validating release 'bpm'... Finished (00:00:00)<br />  Downloading release 'bosh-azure-cpi'... Skipped [Found in local cache] (00:00:00)<br />  Validating release 'bosh-azure-cpi'... Finished (00:00:00)<br />  Downloading release 'os-conf'... Skipped [Found in local cache] (00:00:00)<br />  Validating release 'os-conf'... Finished (00:00:00)<br />  Downloading release 'uaa'... Skipped [Found in local cache] (00:00:00)<br />  Validating release 'uaa'... Finished (00:00:00)<br />  Downloading release 'credhub'... Skipped [Found in local cache] (00:00:00)<br />  Validating release 'credhub'... Finished (00:00:00)<br />  Validating cpi release... Finished (00:00:00)<br />  Validating deployment manifest... Finished (00:00:00)<br />  Downloading stemcell... Skipped [Found in local cache] (00:00:00)<br />  Validating stemcell... Finished (00:00:01)<br />Finished validating (00:00:04)<br />No deployment, stemcell or release changes. Skipping deploy.<br /><br />Succeeded<br />step: created bosh director<br />step: generating cloud config<br />step: applying cloud config<br /></i></span><br /></code></pre>The Load-Balancer is ready to go. You could check this by running <i>"bbl lbs</i>"<br />Next,&nbsp; we will switch back to the concourse folder&nbsp; and execute the command to deploy concourse. Make sure to be in the right folder when you run this command as there are file references&nbsp; in the command.<br /><pre><code><br /><i style="background-color: #f3f3f3;"><br />anandrao at Anands-MBP in ~/pivotal/repos/bbl-az/concourse<br />$ cd concourse-bosh-deployment/cluster<br /><br />anandrao at Anands-MBP in ~/pivotal/repos/bbl-az/concourse/concourse-bosh-deployment/cluster (master)<br />$ pwd<br />/Users/anandrao/pivotal/repos/bbl-az/concourse/concourse-bosh-deployment/cluster</i></code></pre><br />Lets look at the bosh command that is used to deploy concourse as a bosh-deployment.<br /><pre><code><br /><span style="background-color: #f3f3f3;"><i>bosh deploy -d concourse concourse.yml \<br />  -l ../versions.yml \<br />  --vars-store cluster-creds.yml \<br />  -o operations/basic-auth.yml \<br />  -o operations/privileged-http.yml \<br />  -o operations/privileged-https.yml \<br />  -o operations/tls.yml \<br />  -o operations/tls-vars.yml \<br />  -o operations/web-network-extension.yml \<br />  --var network_name=default \<br />  --var external_url='https://wings.az.clue2solve.com' \<br />  --var external_host='wings.az.clue2solve.com' \<br />  --var web_vm_type=default \<br />  --var db_vm_type=default \<br />  --var db_persistent_disk_type=10GB \<br />  --var worker_vm_type=default \<br />  --var deployment_name=concourse \<br />  --var web_network_name=private \<br />  --var local_user.username=admin \<br />  --var local_user.password='$2a$10$CjHFkbuSssxtqtBfqLZ.MuwA0BP589fUd4rXNIM4HwIQ4Dw00NoRq' \<br />  --var web_network_vm_extension=lb</i></span><br /></code></pre></div><br />Few things we need to be careful about here:<br /><br /><ul><li>The external_url should be a valid domain and make sure to include the https://&nbsp; for this value</li><li>The external_host should be a common name ( dns that is valid )&nbsp; without the https</li><li>the local_user.password should be a becrypted value of the password. There is a strong requirement that the password should "bcrypted" at least 10 rounds. I used the website&nbsp;<a href="https://www.browserling.com/tools/bcrypt" target="_blank">https://www.browserling.com/tools/bcrypt</a>&nbsp;and used the generated hash ( make sure you select 10 rounds there&nbsp; ) as the password.&nbsp;</li></ul><br /><a href="https://gist.github.com/honnuanand/e54000119cab94d996757579f8d7530e" target="_blank">Gist here</a> shows the command execution and the output.<br /><br />Hurray ,&nbsp; we successfully deployed concourse. Lets get the DNS Entry for wings ( concourse ) updated with the load balancer IP. you could do this by<br /><br /><pre><code>anandrao at Anands-MBP in ~/pivotal/repos/bbl-az/bbl<br />$ bbl lbs<br />Concourse LB: bbl-env-ontario-2018-07-31t05-15z-concourse-lb (20.189.131.186)<br /></code></pre><br />Update (create one if not already there)  the A-Record on your DNS Zone with the IP.  <br /><br />And Enjoy Concourse !<br /><div class="separator" style="clear: both; text-align: center;"><a href="https://2.bp.blogspot.com/-0X_C6P2-x54/W2CKbUSLhTI/AAAAAAAAGJs/Yb-60BcrnociHUFCvTZluoiVc4v8Nlu1gCPcBGAYYCw/s1600/wings-home-page.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" data-original-height="1285" data-original-width="1600" height="321" src="https://2.bp.blogspot.com/-0X_C6P2-x54/W2CKbUSLhTI/AAAAAAAAGJs/Yb-60BcrnociHUFCvTZluoiVc4v8Nlu1gCPcBGAYYCw/s400/wings-home-page.png" width="400" /></a></div><br /><br />You can create a test pipeline and execute it to test. I suggest starting with&nbsp;<a href="https://concoursetutorial.com/" target="_blank">https://concoursetutorial.com</a>. It is an awesome tutorial to get into concourse.<br /><br />A sample Screen with successful concourse pipelines are below.<br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="https://1.bp.blogspot.com/-mn7LAhrjDSI/W2Pu5shOE-I/AAAAAAAAGKQ/92ob_FxnvgUNRDcAo_htkGNYrKD04bvHQCLcBGAs/s1600/concourse-1.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" data-original-height="1200" data-original-width="1600" height="239" src="https://1.bp.blogspot.com/-mn7LAhrjDSI/W2Pu5shOE-I/AAAAAAAAGKQ/92ob_FxnvgUNRDcAo_htkGNYrKD04bvHQCLcBGAs/s320/concourse-1.png" width="320" /></a></div><br /><div class="separator" style="clear: both; text-align: center;"><a href="https://1.bp.blogspot.com/-d_z6P_d4o08/W2Pu5jqf6yI/AAAAAAAAGKM/dYoDxiOQZoQQLcisg8Fd7VIWoY2J5zDrwCLcBGAs/s1600/concourse-2.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" data-original-height="846" data-original-width="1600" height="169" src="https://1.bp.blogspot.com/-d_z6P_d4o08/W2Pu5jqf6yI/AAAAAAAAGKM/dYoDxiOQZoQQLcisg8Fd7VIWoY2J5zDrwCLcBGAs/s320/concourse-2.png" width="320" /></a></div><br /><br />In the <a href="http://blog.clue2solve.io/2018/08/installing-pcf-2x-on-azure-using.html" target="_blank">Next Part ( Part 3 )&nbsp;</a> of this Series , I will cover the PCF installation using the concourse instance that we just installed.<br /><br /><br /><div class="separator" style="clear: both;">Quick links to the "The PCF on Azure" Blog Series :&nbsp;</div><ul><li><a href="http://blog.clue2solve.io/2018/07/installing-pcf-2x-on-azure-using.html">Installing PCF 2.X on Azure using Concourse - Part - 1 , Bosh Boot loader and bosh</a></li><li><a href="http://blog.clue2solve.io/2018/07/installing-pcf-2x-on-azure-using_31.html">Installing PCF 2.X on Azure using Concourse - Part - 2 , Concourse using bosh</a></li><li><a href="http://blog.clue2solve.io/2018/08/installing-pcf-2x-on-azure-using.html">Installing PCF 2.X on Azure using Concourse - Part - 3 , Installing Pivotal Cloud Foundry using a Pipeline</a></li><li><a href="http://blog.clue2solve.io/2018/07/domain-name-system-dns-delegation-with.html">Domain Name System (DNS) Delegation with Azure DNS Zones</a></li><li><a href="http://blog.clue2solve.io/2018/08/cleanup-azure-pcf-install-using-bbl.html">Cleanup Azure PCF install using BBL</a></li></ul><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br />